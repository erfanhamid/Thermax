@model BEEERP.Models.ViewModel.CommercialVM.ILCOBVModel

@{
    ViewBag.Title = "ILCOB";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .btn:hover {
        color: blue !important;
    }

    .btn:focus {
        background-color: aqua !important;
    }

    .select2-selection--single:focus {
        background-color: aqua !important;
    }
</style>

<div class="content">
    <div class="row">
        <div class="form-horizontal">
            <div class="box-body">
                <div>
                    <h4 style="color:red">@ViewBag.messege</h4>
                </div>
                <div class="row">
                    <div class="col-md-10">
                        <div class="box">
                            <div class="box-header with-border box-head-back" align="center">
                                <h3 class="box-title">ILC Openning Balance</h3>
                            </div>
                            <div class="box-body">
                                <div class="form-group col-md-4">
                                    @Html.LabelFor(m => m.ILCOBNO, new { @class = "col-md-4 control-label" })
                                    <div class="input-group input-group-sm" style="padding-right:15px;padding-left:14px;">
                                        @Html.TextBoxFor(m => m.ILCOBNO, new{ @class = "form-control", @type="number"})
                                        @Html.ValidationMessageFor(m => m.ILCOBNO)
                                        <span class="input-group-btn">
                                            <button type="button" class="btn skin-blue btn-flat" id="search">Search</button>
                                        </span>
                                    </div>
                                </div>
                                <div class="form-group col-md-4">
                                    @Html.LabelFor(m => m.AsonDate, new { @class = "col-md-4 control-label" })
                                    <div class="col-sm-8 input-group" style="padding-left:15px; padding-right:15px">
                                        @Html.TextBoxFor(m => m.AsonDate, new { @class = "form-control ", @ReadOnly = "ReadOnly", @Value = ViewBag.asOn.ToString("dd-MM-yyyy") })
                                        @*<div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>*@
                                    </div>
                                    @Html.ValidationMessageFor(m => m.AsonDate, "", new { @style = "color: red" })
                                </div>
                                <div class="form-group col-md-4">
                                    @Html.LabelFor(m => m.Date, new { @class = "col-md-4 control-label" })
                                    <div class="col-sm-8 input-group" style="padding-left:1.5%; padding-right:1.5%">
                                        @Html.TextBoxFor(m => m.Date, new { @class = "form-control date", @Value = DateTime.Now.ToString("dd-MM-yyyy") })
                                        @Html.ValidationMessageFor(m => m.Date, "", new { @style = "color: red" })
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                    </div>
                                </div>
                                <br />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-10">
                        <div class="box ">
                            <div class="box-body">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        @Html.LabelFor(m => m.ILCID, new { @class = "col-md-4 control-label" })
                                        <div class="input-group input-group-sm" style="padding-right:15px;padding-left:14px;">
                                            @Html.TextBoxFor(m => m.ILCID, new { @class = "form-control", @type = "number" })
                                            @Html.ValidationMessageFor(m => m.ILCID)
                                            <span class="input-group-btn">
                                                <button type="button" class="btn skin-blue btn-flat" id="go">Go</button>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        @Html.LabelFor(m => m.ILCOBalance, new { @class = "col-md-4 control-label" })
                                        <div class="col-sm-8 ">
                                            @Html.TextBoxFor(m => m.ILCOBalance, new { @class = "form-control" })
                                            @Html.ValidationMessageFor(m => m.ILCOBalance, "", new { @style = "color: red" })
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        @Html.LabelFor(m => m.ILCNo, new { @class = "col-md-4 control-label" })
                                        <div class="col-sm-8 ">
                                            @Html.TextBoxFor(m => m.ILCNo, new { @class = "form-control", @ReadOnly = "ReadOnly" })
                                            @Html.ValidationMessageFor(m => m.ILCNo, "", new { @style = "color: red" })
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        @Html.LabelFor(m => m.SupplierName, new { @class = "col-md-4 control-label" })
                                        <div class="col-sm-8 ">
                                            @Html.TextBoxFor(m => m.SupplierName, new { @class = "form-control", @ReadOnly = "ReadOnly" })
                                            @Html.ValidationMessageFor(m => m.SupplierName, "", new { @style = "color: red" })
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-4"></div>
                                    <div style="padding-left:8.25%;" class="col-sm-8 col-sm-offset-4">
                                        <input type="button" name="addToGrid" id="addToGrid" value="Add To Grid" class="btn skin-blue" />
                                    </div>
                                </div>
                                <br />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-10">
                        <div class="box ">
                            <div class="box-header with-border box-head-back">
                                <h3 class="box-title">ILC Opening Balance List</h3>
                            </div>
                            <div class="box-body">
                                <table class="table table-responsive" id="DSIAlist">
                                    <thead>
                                        <tr>
                                            <th>ILC ID</th>
                                            <th>ILC OB</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-10">
                        <div class="form-group">
                            <div class="col-md-2"></div>
                            <div class="col-md-8" style="text-align:center;">
                                <input type="button" value="Save" id="save" class="btn btn-primary" style="padding-left:20px;" />
                                <input type="button" name="update" id="update" value="Update" class="btn btn-primary" />
                                <input type="button" name="delete" id="delete" value="Delete" class="btn btn-primary" />
                                <input type="button" name="refresh" id="refresh" value="Refresh" class="btn btn-primary" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script src="~/Scripts/Common.js"></script>
    <script src="~/Scripts/CommercialModule/ILCOBInputFocus.js"></script>
    <script>

          var isValid = true;
          var addedItems = [];
          var lcob = { ILCOBNO: 0, Date: "" };

          $('.date').datepicker({
              autoclose: true,
              format: 'dd-mm-yyyy',
          });

          var table = $('#DSIAlist').DataTable({
              'paging': false,
              'lengthChange': false,
              'searching': true,
              'ordering': true,
              'info': true,
              'autoWidth': false
          });

          EnterPress();
          
          $(document).ready(function () {
              $("#update").hide();
              $("#delete").hide();
              $("#ILCID").focus();
          });

          $(document).on('click', "#refresh", function () {
              location.reload();
          });

          //LC Search Code
          $(document).on('click', "#go", function () {
              RemoveError();
              var id = { lcId: $("#ILCID").val() };
              if (id.lcId != "") {
                  $.ajax({
                      url: '@Url.Action("GetLCByLCId", "ILCOB")',
                      contentType: "application/json;charset=utf-8",
                      data: id,
                      type: 'GET',
                      dataType: 'json',
                      success: function (datas) {
                          if (datas != 0) {
                              $("#ILCNo").val(datas.LCNo);
                              $("#SupplierName").val(datas.SupplierName);
                          }
                          else {
                              alert("This Lc Id Doesn't Exist.");
                          }
                      }
                  });
              }
              else {
                  setError("ILCID", "ILC ID is Required For get LC.");
              }
          });

          $(document).on('click', '#addToGrid', function () {
              RemoveError();
              var item = { ILCOBNO: 0, ILCID: 0, ILCOBalance: 0 };
              ValidateAddToGrid();
              if (isValid == true) {
                  item.ILCID = $("#ILCID").val();
                  item.ILCOBalance = $("#ILCOBalance").val();
                  addedItems.push(item);
                  ClearOnSearch();
                  ShowOnTable();
              }
          });

          //delete Row
          $(document).on('click', '[name="deleteRow"]', function () {
              var item = $(this).attr("value");
              var newItem = [];
              if (confirm('Are you sure you want to delete this from Grid ?')) {
                  $.each(addedItems, function (index, value) {
                      if (value.ILCID == item) {

                      }
                      else {
                          newItem.push(value);
                      }

                  });
                  addedItems = newItem;
                  ShowOnTable();
              }
          });


          //edit Row
          $(document).on('click', '[name="editRow"]', function () {
              var item = $(this).attr("value");
              var newItem = [];
              $.each(addedItems, function (index, value) {
                  if (value.ILCID == item) {
                      $("#ILCID").val(value.ILCID);
                      $("#ILCOBalance").val(value.ILCOBalance);
                      $("#go").click();
                  }
                  else {
                      newItem.push(value);
                  }

              });
              addedItems = newItem;
              ShowOnTable();
          });

          //save code
          $(document).on('click', '#save', function () {
              RemoveError();
              $("#save").prop('disabled', true);
              SetLcob();
              if (addedItems.length <= 0) {
                  alert("At least One Item should be added for save.");
                  $("#save").prop('disabled', false);
              }
              else {
                  ValidateLcob();
                  if (isValid == true) {
                      if (confirm('Do you want to save')) {
                          $.ajax({
                              url: '@Url.Action("SaveILCOB", "ILCOB")',
                              contentType: "application/json;charset=utf-8",
                              data: JSON.stringify({ lcob: lcob, addedItems: addedItems }),
                              type: 'POST',
                              dataType: 'json',
                              success: function (datas) {
                                  if (datas == 0) {
                                      alert("Failed To Saved.");
                                      $("#save").prop('disabled', false);
                                  }
                                  else {
                                      alert("Sucessfully Saved.");
                                      $("#ILCOBNO").val(datas.lcob.ILCOBNO);
                                      $("#save").prop('disabled', true);
                                  }
                              }
                          });
                      }
                      else {
                          $("#save").prop('disabled', false);
                      }
                  }
                  else {
                      $("#save").prop('disabled', false);
                  }
              }
          });

          //search code
          $(document).on('click', '#search', function () {
              $("#search").prop('disabled', true);
              var id = { id: $("#ILCOBNO").val() };
              ClearOnSearch();
              if ($("#ILCOBNO").val() != "") {
                  $.ajax({
                      url: '@Url.Action("GetILCOBById", "ILCOB")',
                      contentType: "application/json;charset=utf-8",
                      data: id,
                      type: 'GET',
                      dataType: 'json',
                      success: function (datas) {

                          if (datas == 0) {
                              alert("Your entered ILCOB No. Doesn't exist");
                              $("#search").prop('disabled', false);
                          }
                          else {
                              $("#save").hide();
                              $("#update").show();
                              $("#delete").show();
                              $("#Date").val((moment(datas.lcobItem.Date).format("DD-MM-YYYY")));
                              $("#ILCOBNO").val(datas.lcobItem.ILCOBNO);
                              addedItems = [];
                              $.each(datas.lcobLineItem, function (index, value) {
                                  var item = { ILCOBNO: 0, ILCID: 0, ILCOBalance: 0 };
                                  item.ILCOBNO = value.ILCOBNO;
                                  item.ILCID = value.ILCID;
                                  item.ILCOBalance = value.ILCOBalance;
                                  addedItems.push(item);
                              });
                              ShowOnTable();
                              $("#search").prop('disabled', true);
                          }
                      },
                      error: function () {
                          alert("Please check your internet connection first. If this doesn't solve your problem, then Contact With Paankouri Software & Services")
                          $("#search").prop('disabled', false);
                      }
                  });
              }
              else {
                  alert("ILCOB NO is required for get data.");
                  $("#search").prop('disabled', false);
              }
              
          });

          //update
          $(document).on('click', '#update', function () {
              RemoveError();
              $("#update").prop('disabled', true);
              SetLcob();
              lcob.ILCOBNO = $("#ILCOBNO").val();
          
              if (addedItems.length <= 0) {
                  alert("At least One Item should be added for Update.");
                  $("#update").prop('disabled', false);
              }
              else {
                  ValidateLcob();
                  if (confirm('Do you want to Update')) {
                      if (isValid == true) {
                      $.ajax({
                          url: '@Url.Action("UpdateILCOB", "ILCOB")',
                          contentType: "application/json;charset=utf-8",
                          data: JSON.stringify({ lcob: lcob, addedItems: addedItems }),
                          type: 'POST',
                          dataType: 'json',
                          success: function (datas) {
                              if (datas == 0) {
                                  alert("Failed To Update.");
                                  $("#update").prop('disabled', false);
                              }
                              else {
                                  alert("Sucessfully Updated.");
                                  $("#update").prop('disabled', true);
                              }
                          }
                      });
                  }
                      else {
                          $("#update").prop('disabled', false);
                      }
                  }
                  else {
                      $("#update").prop('disabled', false);
                  }
              }
          
          });

          //delete code
          $(document).on('click', '#delete', function () {
              $("#update").prop('disabled', true);
              $("#delete").prop('disabled', true);
              var id = $("#ILCOBNO").val();
              if (confirm('Are you sure you want to delete this from the database?')) {
                  $.ajax({
                      url: '@Url.Action("DeleteLCOBByid", "ILCOB")',
                      contentType: "application/json;charset=utf-8",
                      data: { id: id },
                      type: 'GET',
                      dataType: 'json',
                      success: function (datas) {
                          if (datas == 0) {
                              alert("Delete failed.");
                              $("#delete").prop('disabled', false);
                              $("#update").prop('disabled', false);
                          }
                          else {
                              alert("Delete Successfull");
                              location.reload();
                          }
                      }
                  });
              }
              else {
                  $("#update").prop('disabled', false);
                  $("#delete").prop('disabled', false);
              }
          });

          function ShowOnTable() {
              table.clear().draw();
              $.each(addedItems, function (index, value) {
                  table.row.add([value.ILCID, value.ILCOBalance,
                  '<a href="#"><i class="fa fa-edit" name="editRow" value="' +
                  value.ILCID + '"></i></a> &ensp;&ensp;&ensp;<a href="#"><i class="fa fa-trash" name="deleteRow" value="' + value.ILCID + '"></i></a>']).draw();
              });
          }



          function ValidateAddToGrid() {
              isValid = true;
              if ($("#ILCID").val() == "") {
                  setError("ILCID", "ILC ID is required field");
                  isValid = false;
              }
              if ($("#ILCNo").val() == "") {
                  setError("ILCNo", "ILC No is required field");
                  isValid = false;
              }
              if ($("#ILCOBalance").val() == "") {
                  setError("ILCOBalance", "ILC OB is required field");
                  isValid = false;
              }
              if ($("#ILCOBalance").val() <= 0) {
                  setError("ILCOBalance", "IL COB must be grater than Zero");
                  isValid = false;
              }
              $.each(addedItems, function (index, value) {
                  if (value.ILCID == $("#ILCID").val()) {
                      setError("ILCID", "This LC is Already Added.");
                      isValid = false;
                  }
              });
          }

          function ClearOnSearch() {
              $("#ILCID").val("");
              $("#ILCOBalance").val("");
              $("#ILCNo").val("");
              $("#SupplierName").val("");
          }

          function SetLcob() {
              lcob.ILCOBNO = 0;
              lcob.Date = $("#Date").val();
          }

          function ValidateLcob() {
              isValid = true;
              if (lcob.Date == "") {
                  setError("Date", "Date is required field");
                  isValid = false;
              }
          }

    </script>
}